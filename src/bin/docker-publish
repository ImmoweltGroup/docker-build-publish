#!/usr/bin/env node

const logger = require('log-fancy')('@immowelt/docker-publish');
const cli = require('commander');
const defaultFlow = require('./../commands/default.js');
const pkg = require('./../../package.json');

cli
	.option('--github-api-tags-url <url>', 'The file path of the config file you want to use.')
	.option('--dockerImage <string>', 'The path / url to the docker image (Note that we append the target tag via the "--dockerTag" option).')
	.option('--versionBuildArgKey <string>', 'The app ID of the instance.')
	.description('Fetches the given tags, filters out release only tags based on semver and builds/pushes the given docker image.')
	.version(pkg.version)
	.parse(process.argv);

if (cli.rawArgs.length !== 3) {
	cli.help();

	return;
}

(async function () {
	const {githubApiTagsUrl, dockerImage, versionBuildArgKey} = cli;

	try {
		await defaultFlow({
			githubApiTagsUrl,
			dockerImage,
			versionBuildArgKey
		});
	} catch (err) {
		logger.error(`Something went wrong while building and pushing the images:`);
		logger.fatal((err.message || err));
	}
})();
